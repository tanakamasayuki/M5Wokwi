# M5UnifiedW

M5UnifiedW は、Wokwi シミュレータ上で M5Unified API の軽量なサブセットを再現する Arduino ライブラリです。既存のスケッチで `#include "M5Unified.h"` を `#include "M5UnifiedW.h"` に差し替えるだけで、実機がなくても馴染みのあるディスプレイ描画やボタン操作を試せる環境を提供します。

## このプロジェクトを選ぶ理由
- **UI 調整の高速化:** 実機への書き込み前にデスクトップ上で配色やレイアウト、アニメーションを素早く検証できます。
- **学習コストの低減:** ハードウェアを持たない学習者やコラボレーターでも M5Stack エコシステムを体験できます。
- **決定論的なリグレッションテスト:** 決定論的なシミュレーションにより描画処理のリグレッションを検出しやすくします。

## 対象スコープ（v0.x）
- スタブ化した `M5` 名前空間 / クラスを提供し、以下の機能を公開します。
  - Wokwi がサポートする画面にマッピングされた基本的な描画プライミティブ（`fillRect`、`drawString`、`setCursor` など）。
  - M5Stack 本体の 3 つのフロントボタンに合わせたボタン状態の取得。
- 既存スケッチの変更を最小限に抑えるため、ビルド時に足りない記号を補うためのシムを用意します。
- 対応ディスプレイ部品へライブラリを接続した最小限の Wokwi プロジェクトテンプレートを提供します。

## ストレッチ目標
- Wokwi が対応する範囲で IMU、スピーカー、電源管理などの周辺機能を再現します。
- 設定フラグによる複数ボードプロファイル（Core、Core2、CoreS3 など）の切り替えに対応します。
- Wokwi コンポーネント ID や解像度を抽象化するレイヤーを整備します。

## アーキテクチャ概要
- **ファサード:** `M5UnifiedW` が `M5Unified` の公開 API 表面を模倣し、バックエンドサービスへ委譲します。
- **バックエンド:** 表示・入力バックエンドが Wokwi コンポーネントと紐づき、デフォルト実装は 320×240 TFT を想定します。
- **設定:** JSON もしくは C++ 定数で構成した軽量設定構造体により、ボードごとのピン配置や画面ジオメトリを定義します。
- **フォールバック:** 未実装 API はビルドを通すための no-op スタブやコンパイル時診断を提供します。

## はじめに
1. ライブラリを Arduino プロジェクトに導入します（手動配置または公開後に Library Manager からインストール）。
2. インクルード文を次のように置き換えます。
   ```cpp
   #include "M5UnifiedW.h"
   ```
3. M5UnifiedW と互換性のあるディスプレイおよびボタンを定義した Wokwi の diagram JSON をスケッチに含めます。
4. Wokwi 上でビルドし、シミュレーションを実行します。

> 初期プロトタイプが完成次第、導入手順と Wokwi 設定の詳細を追記します。

## 開発ロードマップ
| マイルストーン | 説明 | 状態 |
| --- | --- | --- |
| M0 | API 表面のドラフト、スタブ、ドキュメント整備 | 計画中 |
| M1 | 基本描画プライミティブとボタンポーリング | 計画中 |
| M2 | サンプルスケッチと Wokwi テンプレート | 計画中 |
| M3 | Arduino Library Manager での公開 | 計画中 |

## コントリビューション
- `AGENTS.md` に記載されたワークフローと意思決定ガイドラインに従ってください。
- 大きな作業を始める前に Issue を作成し、プルリクエストから参照します。
- 変更に合わせてドキュメントとシミュレータの図面を更新してください。

## 未解決の論点
- Wokwi のイベントループ内で `M5.update()` のようなブロッキング呼び出しをどのように扱うか。
- M5Stack 固有のフォントやスプライトバッファを Wokwi の表示モデルへどうマッピングするか。
- `M5.Speaker` などのオプション機能を、リンカ負荷を抑えつつ発見しやすい形で構成する方法。

## ライセンス
このプロジェクトは [CC0 1.0 Universal](https://creativecommons.org/publicdomain/zero/1.0/) ライセンスのもとでパブリックドメインに供されます。
